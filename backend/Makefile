docs:
	rm -rf ../docs/_build/html ../docs/_build/doctrees
	poetry run sphinx-build -M html ../docs ../docs/_build

schema:
	mkdir -p ../data
	poetry run yoyo apply --batch
	printf -- "-- This file is for documentation purposes only.\n" > schema.sql
	printf -- "-- It is autogenerated from the migrations, please do NOT edit!\n\n" >> schema.sql
	sqlite3 ../data/db.sqlite3 .schema | tail -n +5 | awk '{if (NR>1) gsub(/^CREATE/, "\nCREATE")}1' >> schema.sql

setup.py:
	poetry export > requirements.txt
	poetry run dephell deps convert --from pyproject.toml --to setup.py

lint:
	poetry run black .
	poetry run isort .
	poetry run flake8 .

tests:
	poetry run pytest --cov=. --cov-branch tests/
	poetry run coverage html

typecheck:
	poetry run mypy src/

lintcheck:
	poetry run black --check .
	poetry run isort -c .
	poetry run flake8 .

schemacheck:
	mv schema.sql schema.sql.old
	make schema
	diff schema.sql.old schema.sql
	rm schema.sql.old

setupcheck:
	mv setup.py setup.py.old
	mv requirements.txt requirements.txt.old
	make setup.py
	diff setup.py.old setup.py
	diff requirements.txt.old requirements.txt
	rm setup.py.old requirements.txt.old

.PHONY: docs setup.py lint tests typecheck lintcheck schemacheck setupcheck
